# Streamlit側だけでの堅実性・安定性向上 評価

## 結論
**可能です。** GASを変更しなくても、Streamlit側の「取得方法」「再試行」「キャッシュ」「フォールバック表示」を強化することで、体感可用性は大きく改善できます。

## 現状フロント実装から見える強み
このリポジトリの現行実装（`index.html`）でも、安定性に効く基本対策は既に一部入っています。

- JSONP未着時のタイムアウト表示（4秒）
- `songs/gags/archive` のクライアントキャッシュ
- `archive` の `localStorage` 永続キャッシュ
- 取得失敗時のUIメッセージ分岐

上記は「完全停止を避ける」設計として有効です。

## Streamlit側で追加すると効果が高い対策（GAS無改修）

### 1. サーバー側取得 + 再試行（最優先）
- ブラウザJSONP直叩きを避け、**StreamlitサーバーがGASを取得**して画面に渡す
- `requests` で `timeout` + `Retry`（指数バックオフ）
- 失敗時は「直近成功キャッシュ」を返す

**効果**
- 一時的なネットワーク断・レート制限の吸収
- クライアント差異（CORS/拡張機能/広告ブロッカー影響）低減

### 2. 多層キャッシュ（TTL + stale-while-revalidate）
- `st.cache_data(ttl=...)` を利用
- キャッシュ期限切れ時も、即時に古いデータを表示しつつ裏で更新

**効果**
- 初回以外の待ち時間短縮
- GAS側遅延のユーザー影響を最小化

### 3. スキーマ防御（列名ゆれ・欠損対策）
- `artist/title/kind/dText/dUrl` を正規化する関数を集約
- 欠損時のデフォルト値を厳密化

**効果**
- シート列名変更や空値混入でも落ちにくい

### 4. フェイルソフトUI
- 「最新取得成功時刻」「現在はキャッシュ表示中」を明示
- タブ単位（songs/gags/archive）でエラーを局所化

**効果**
- 障害時でも操作継続しやすい
- 問い合わせ時の切り分けが容易

## 期待できる改善幅（定性的）
- **可用性**: 中〜大幅改善
- **平均応答時間**: 中改善
- **データ鮮度**: TTL設計次第（短TTLなら現状同等〜微改善）
- **実装難易度**: 低〜中（GAS無改修なので導入しやすい）

## リスク・限界
- GASが長時間停止している場合、最終的にはキャッシュ依存
- 完全な整合性保証（厳密トランザクション）はGAS無改修では困難

## 推奨実施順（短期）
1. Streamlitで取得を集約し、`timeout + retry + cache` を実装
2. 正規化関数を1箇所に統合
3. 失敗時UI（キャッシュ表示中バッジ、最終更新時刻）を追加
4. ログ計測（取得成功率・遅延）を追加

---

本評価は「GAS設定を変えない」前提で、現行クライアント実装の設計を踏まえて整理しています。
