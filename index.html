<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#e6f6ff">
  <title>歌唱曲・一発ネタ 検索</title>
  <style>
    :root{
      --bg:#e6f6ff; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --line:#e5e7eb;
      --thead:#dff1ff; --focus:#3897c9; --chip-bg:#f3f4f6; --chip-text:#111827;
      --tab-bg:#ffffff; --tab-active:#c8e7ff; --tab-border:#cbd5e1;
      --violet:#7c3aed; /* 最古▶の色（紫） */
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;line-height:1.7;margin:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .row-controls{margin-top:8px}
    .tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--tab-border);background:var(--tab-bg);color:var(--text);border-radius:999px;padding:8px 14px;font-size:14px;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--tab-active);font-weight:700}
    .tab:focus{outline:3px solid var(--focus);outline-offset:2px}
    input[type="search"],select{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff;color:var(--text);outline:none}
    input[type="search"]:focus,select:focus,.btn:focus,.chip:focus,.link-icon:focus{outline:3px solid var(--focus);outline-offset:2px}
    #limit{padding:6px 10px;font-size:14px;line-height:1.2;max-width:160px}
    .muted{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#f9fafb}
    .btn:active{transform:translateY(1px)}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}
    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:15px;vertical-align:top}
    th{position:sticky;top:0;background:var(--thead);z-index:1;font-weight:700}
    th:nth-child(1),td:nth-child(1){width:28%}
    th:nth-child(2),td:nth-child(2){width:44%}
    th:nth-child(3),td:nth-child(3){width:12%}
    th:nth-child(4),td:nth-child(4){width:16%}
    .ops{display:flex;align-items:center;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;max-width:100%;padding:4px 8px;border-radius:999px;font-size:14px;background:var(--chip-bg);color:var(--chip-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border:1px solid var(--line)}
    .link-icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;line-height:1;text-decoration:none;font-size:18px;border-radius:8px}
    .link-icon:hover{background:#f3f4f6}
    .link-icon:active{transform:translateY(1px)}
    .link-icon--oldest{color:var(--violet)} /* 最古▶を紫に */
    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{border-bottom:1px solid var(--line);padding:12px 2px;display:flex;flex-direction:column;gap:6px}
      .l1{font-size:16px;line-height:1.6;font-weight:700;display:flex;gap:6px;flex-wrap:wrap}
      .l1 .sep{opacity:.6}
      .l2{display:flex;align-items:center;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <!-- 検索UI -->
  <div class="card">
    <div class="tabs" role="tablist" aria-label="検索対象">
      <button id="tab-songs" class="tab" role="tab" aria-selected="true"  data-tab="songs">歌唱曲</button>
      <button id="tab-gags"  class="tab" role="tab" aria-selected="false" data-tab="gags">一発ネタ</button>
    </div>
    <div class="row">
      <input id="q" type="search" placeholder="曲名／アーティスト名で検索（例：群青日和／椎名林檎）" autocomplete="off">
    </div>
    <div class="row row-controls">
      <select id="limit">
        <option value="50">上限 50件</option>
        <option value="100">上限 100件</option>
        <option value="200">上限 200件</option>
      </select>
    </div>
    <div class="muted" id="status">読み込み中…</div>
    <div class="muted" id="debug" style="margin-top:6px; word-break:break-all;"></div>
  </div>

  <!-- 結果表示 -->
  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">検索結果がここに表示されます。</div>
    <div id="table"   style="display:none;"></div>
    <div id="mblist"  class="mobile-list" style="display:none;"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">コピーしました</div>

  <script>
    /* ===== 設定 ===== */
    // 必ず /macros/s/<DEPLOY_ID>/exec（/u/N なし）を設定
    const API_URL = 'https://script.google.com/macros/s/AKfycbzmWYRODUKMurNKLDzq23Ct5IEogfXk1BDucSY4KjzepJwOgVpV0EVgvwuzjS9KJW2axQ/exec';
    const HARD_LIMIT = 200;
    const ARCHIVE_KEY = 'archive'; // GAS 側：アーカイブシート用の sheet 名

    const state = {
      current: 'songs',                 // 'songs' | 'gags'
      cache: { songs:null, gags:null, archive:null },
      archiveMap: null,                 // { key => [{date,url}] }  ※key = norm(artist)+'|'+norm(title)
      rows: [],
      debounce: null,
      lastRequested: null
    };

    /* ===== ユーティリティ ===== */
    function $(id){ return document.getElementById(id) }
    function normalize(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim() }
    function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400) }
    async function copyPair(title, artist){
      const text = `${(title||'').trim()} / ${(artist||'').trim()}`.trim();
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        showToast('コピーしました：' + text);
      }catch{ showToast('コピーに失敗しました'); }
    }
    function scheduleSearch(){ clearTimeout(state.debounce); state.debounce=setTimeout(render,220); }

    // D列テキストからURLを拾うフォールバック（dUrlが無い時）
    function urlFromText(s){
      if (!s) return '';
      const m = String(s).match(/https?:\/\/\S+/);
      return m ? m[0].replace(/[)\]\s]+$/,'') : '';
    }

    // アーカイブの rows → map 生成（key=artist|title / 値= [{date,url}] 降順ソート）
    function buildArchiveMap(rows){
      const map = new Map();
      (rows||[]).forEach(({artist,title,dText,dUrl})=>{
        const key = `${normalize(artist)}|${normalize(title)}`;
        const txt = dText || '';
        const m = /^(\d{8})/.exec(txt);           // 先頭 yyyymmdd
        const date = m ? parseInt(m[1],10) : 0;
        const url = dUrl || urlFromText(dText);
        if (!url) return;
        if (!map.has(key)) map.set(key, []);
        map.get(key).push({date, url});
      });
      for (const [k,arr] of map) arr.sort((a,b)=> b.date - a.date || (a.url>b.url?1:-1)); // 新→古
      return map;
    }

    /* ===== JSONP コールバック ===== */
    let __jsonpHit = false;

    function onGviz(payload){
      __jsonpHit = true;
      try{
        if (!payload || !payload.rows) throw new Error('payload.rows missing');

        const tab = state.lastRequested || state.current;
        const rows = (payload.rows||[]).filter(r => ((r.artist||'')+(r.title||'')).trim()!=='');
        state.cache[tab] = rows;

        if (tab === ARCHIVE_KEY) {
          state.archiveMap = buildArchiveMap(rows);
        }

        // 初回描画は「現在タブのデータ」と「archive」の両方が揃ってから行う
        const haveCurrent = !!state.cache[state.current];
        const haveArchive = !!state.archiveMap;
        if (haveCurrent && haveArchive) {
          state.rows = state.cache[state.current] || [];
          $('status').textContent = `読み込み完了：${state.rows.length}件`;
          render();
        } else {
          $('status').textContent = haveCurrent ? '履歴を読み込み中…' : '読み込み中…';
        }
      }catch(e){
        console.error(e);
        $('status').textContent='読み込みに失敗しました';
      }
    }
    window.onGviz = onGviz;

    // JSONP未着監視（4秒で警告）
    setTimeout(()=>{
      if(!__jsonpHit){
        $('status').textContent = 'データ取得に失敗しました（JSONP未着／API_URLとデプロイ設定を確認）';
      }
    }, 4000);

    /* ===== データ取得（リダイレクト強耐性：A/B/C フォールバック） ===== */
    function requestData(tab){
      state.lastRequested = tab;

      const baseNorm = API_URL.replace(/\/macros\/u\/\d+\//, '/macros/'); // 正規化
      const mk = (u,auth0=true)=> `${u}?callback=onGviz&sheet=${encodeURIComponent(tab)}${auth0?'&authuser=0':''}&v=${Date.now()}`;
      const candidates = [
        mk(baseNorm, true),                                   // A: 正規 + authuser=0
        mk(baseNorm.replace('/macros/', '/macros/u/0/'), true), // B: /u/0/ を明示 + authuser=0
        mk(baseNorm, false)                                   // C: 正規（authuser 無し）
      ];

      // デバッグ表示
      $('debug').innerHTML = `JSONP URL 候補:<br>` + candidates.map(u =>
        `<a target="_blank" rel="noopener" href="${u}">${u}</a>`
      ).join('<br>');

      // 順次トライ
      let idx = 0, hit = false, timer = null;
      __jsonpHit = false;

      const tryNext = () => {
        if (hit || idx >= candidates.length) return;
        const url = candidates[idx++];
        const s = document.createElement('script');
        s.src = url;
        s.onerror = () => {
          if (!hit && idx < candidates.length) setTimeout(tryNext, 600);
          else if (!hit) $('status').textContent = 'データ取得に失敗しました（JSONP未着／リダイレクト・拡張を確認）';
        };
        document.head.appendChild(s);
        clearTimeout(timer);
        timer = setTimeout(() => {
          if (!__jsonpHit && !hit) tryNext();
        }, 1200);
      };

      const orig = window.onGviz;
      window.onGviz = function(payload){
        hit = true; __jsonpHit = true; clearTimeout(timer);
        try { orig(payload); } finally { window.onGviz = orig; }
      };

      $('status').textContent = '読み込み中…（リダイレクト対策中）';
      tryNext();
    }

    function requestCurrentAndArchive(tab){
      // 現在タブ
      if (!state.cache[tab]) requestData(tab);
      // アーカイブ
      if (!state.archiveMap) requestData(ARCHIVE_KEY);
    }

    function setActiveTab(tab){
      state.current = tab;
      document.querySelectorAll('.tab').forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab===tab)));
      $('status').textContent='読み込み中…';
      requestCurrentAndArchive(tab);
      // すでに両方揃っていれば即描画
      if (state.cache[tab] && state.archiveMap) {
        state.rows = state.cache[tab];
        $('status').textContent = `読み込み完了：${state.rows.length}件`;
        render();
      }
    }

    /* ===== 描画（PC=テーブル、モバイル=2行リスト／3つの▶を必ず試行） ===== */
    function render(){
      const tableWrap = $('table'); tableWrap.innerHTML = '';
      const listWrap  = $('mblist'); listWrap.innerHTML = '';
      const hint = $('hint');

      // 両方揃っていないなら描画しない（3つの▶を保証するため）
      if (!state.cache[state.current] || !state.archiveMap) {
        $('status').textContent = '履歴を読み込み中…';
        tableWrap.style.display = 'none';
        listWrap.style.display  = 'none';
        return;
      }

      const q = normalize($('q').value||'');
      const limit = Math.min(parseInt($('limit').value,10)||50, HARD_LIMIT);

      let filtered = state.cache[state.current] || [];
      if(q){
        filtered = filtered.filter(({artist,title})=>{
          const a=normalize(artist), t=normalize(title);
          return a.includes(q) || t.includes(q);
        });
      }
      const rows = filtered.slice(0, limit);

      $('status').textContent = q
        ? `${rows.length}件ヒット（全${filtered.length}件）／表示上限 ${limit}件`
        : `表示中 ${rows.length}件（全${(state.cache[state.current]||[]).length}件）／表示上限 ${limit}件`;

      if(rows.length===0){
        hint.textContent = q ? '該当なし' : '検索結果がここに表示されます。';
        tableWrap.style.display = 'none';
        listWrap.style.display  = 'none';
        return;
      }
      hint.textContent = '';

      const isMobile = window.matchMedia('(max-width: 768px)').matches;

      const getArchiveLinks = (artist, title, latestUrl) => {
        const key = `${normalize(artist)}|${normalize(title)}`;
        const arr = state.archiveMap.get(key) || [];
        // 先に最新URLを登録して重複回避
        const seen = new Set([latestUrl||'']);
        const uniq = [];
        for (const {url} of arr) {
          if (!url || seen.has(url)) continue;
          seen.add(url); uniq.push(url);
        }
        const second = uniq[0] || '';                         // 2番目に新しい
        const oldest = uniq.length ? uniq[uniq.length-1] : ''; // 最古
        return { second, oldest };
      };

      // ── PC：テーブル
      if (!isMobile) {
        const table=document.createElement('table');
        const thead=document.createElement('thead');
        const trh=document.createElement('tr');
        ['アーティスト名','曲名','区分','履歴'].forEach(h=>{
          const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);
        });
        thead.appendChild(trh); table.appendChild(thead);

        const tbody=document.createElement('tbody');
        rows.forEach(({artist,title,kind,dText,dUrl})=>{
          const tr=document.createElement('tr');

          let td=document.createElement('td'); td.textContent=artist||''; tr.appendChild(td);
          td=document.createElement('td'); td.textContent=title||''; tr.appendChild(td);

          td=document.createElement('td');
          if (kind){ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=kind; td.appendChild(chip); }
          tr.appendChild(td);

          const tdOps=document.createElement('td');
          const ops=document.createElement('div'); ops.className='ops';

          // ① 最新（歌唱曲/一発ネタのD列）
          const latest = dUrl || urlFromText(dText);
          if (latest){
            const a=document.createElement('a');
            a.href=latest; a.target='_blank'; a.rel='noopener';
            a.className='link-icon'; a.textContent='▶';
            a.setAttribute('aria-label','最新の履歴を開く'); a.title='最新の履歴を開く';
            ops.appendChild(a);
          }

          // ② 2番目（archiveの中で最新）／③ 最古（archiveの末尾）
          const { second, oldest } = getArchiveLinks(artist, title, latest);
          if (second){
            const a2=document.createElement('a');
            a2.href=second; a2.target='_blank'; a2.rel='noopener';
            a2.className='link-icon'; a2.textContent='▶';
            a2.setAttribute('aria-label','2番目に新しい履歴を開く'); a2.title='2番目に新しい履歴を開く';
            ops.appendChild(a2);
          }
          if (oldest){
            const ao=document.createElement('a');
            ao.href=oldest; ao.target='_blank'; ao.rel='noopener';
            ao.className='link-icon link-icon--oldest'; ao.textContent='▶';
            ao.setAttribute('aria-label','最も古い履歴を開く'); ao.title='最も古い履歴を開く';
            ops.appendChild(ao);
          }

          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='コピー';
          btn.addEventListener('click', ()=>copyPair(title,artist));
          ops.appendChild(btn);

          tdOps.appendChild(ops);
          tr.appendChild(tdOps);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableWrap.appendChild(table);
        tableWrap.style.display = 'block';
        listWrap.style.display  = 'none';

      // ── モバイル：2行リスト
      } else {
        rows.forEach(({artist,title,kind,dText,dUrl})=>{
          const item=document.createElement('div'); item.className='item';

          const l1=document.createElement('div'); l1.className='l1';
          const a1=document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
          const sep=document.createElement('span'); sep.className='sep'; sep.textContent='/';
          const t1=document.createElement('span'); t1.className='title'; t1.textContent=title||'';
          l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

          const l2=document.createElement('div'); l2.className='l2';

          if (kind){ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=kind; l2.appendChild(chip); }

          const latest = dUrl || urlFromText(dText);
          if (latest){
            const a=document.createElement('a');
            a.href=latest; a.target='_blank'; a.rel='noopener';
            a.className='link-icon'; a.textContent='▶';
            a.setAttribute('aria-label','最新の履歴を開く'); a.title='最新の履歴を開く';
            l2.appendChild(a);
          }
          const { second, oldest } = getArchiveLinks(artist, title, latest);
          if (second){
            const a2=document.createElement('a');
            a2.href=second; a2.target='_blank'; a2.rel='noopener';
            a2.className='link-icon'; a2.textContent='▶';
            a2.setAttribute('aria-label','2番目に新しい履歴を開く'); a2.title='2番目に新しい履歴を開く';
            l2.appendChild(a2);
          }
          if (oldest){
            const ao=document.createElement('a');
            ao.href=oldest; ao.target='_blank'; aorel='noopener';
            ao.className='link-icon link-icon--oldest'; ao.textContent='▶';
            ao.setAttribute('aria-label','最も古い履歴を開く'); ao.title='最も古い履歴を開く';
            l2.appendChild(ao);
          }

          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='コピー';
          btn.addEventListener('click', ()=>copyPair(title,artist));
          l2.appendChild(btn);

          item.appendChild(l1); item.appendChild(l2);
          listWrap.appendChild(item);
        });

        listWrap.style.display  = 'block';
        tableWrap.style.display = 'none';
      }
    }

    // 画面幅変更に追随（軽いデバウンス）
    window.addEventListener('resize', scheduleSearch);

    // 初期化（必ず現在タブ＋アーカイブを同時にロード）
    (function init(){
      document.getElementById('tab-songs').addEventListener('click', ()=> setActiveTab('songs'));
      document.getElementById('tab-gags').addEventListener('click',  ()=> setActiveTab('gags'));
      $('q').addEventListener('input', scheduleSearch);
      $('limit').addEventListener('change', render);
      setActiveTab('songs');             // 現在タブ
      requestCurrentAndArchive('songs'); // アーカイブも並行ロード
    })();
  </script>
</body>
</html>
