<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#e6f6ff">
  <title>æ­Œå”±æ›²ãƒ»ä¸€ç™ºãƒã‚¿ æ¤œç´¢ï¼ˆå±¥æ­´ é«˜é€ŸåŒ–ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#e6f6ff; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --line:#e5e7eb;
      --thead:#dff1ff; --focus:#3897c9; --tab-bg:#ffffff; --tab-active:#c8e7ff; --tab-border:#cbd5e1; --link:#2563eb;
      --chip-bg:#f3f4f6; --chip-text:#111827;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;line-height:1.7;margin:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}

    .topbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin-bottom:8px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--tab-border);background:var(--tab-bg);color:var(--text);border-radius:999px;padding:8px 14px;font-size:14px;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--tab-active);font-weight:700}
    .tab:focus{outline:3px solid var(--focus);outline-offset:2px}
    .limit-wrap{display:flex;align-items:center;gap:8px}
    #limit{padding:6px 10px;font-size:14px;line-height:1.2;width:auto;min-width:120px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    input[type="search"],select{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff;color:var(--text);outline:none}
    input[type="search"]:focus,select:focus,.btn:focus,.link-icon:focus{outline:3px solid var(--focus);outline-offset:2px}

    .dm-wrap{display:flex;align-items:center;gap:8px;margin-top:8px}
    .dm-select-wrap{flex:7 1 0}
    .dm-btn-wrap{flex:3 1 0;display:flex}
    #dm-select{width:100%;padding:6px 10px;font-size:14px;line-height:1.2}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#f9fafb}
    .btn:active{transform:translateY(1px)}
    .btn-full{width:100%}

    .muted{color:var(--muted);font-size:13px}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .2s}
    .toast.show{opacity:1}

    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:15px;vertical-align:top}
    th{position:sticky;top:0;background:var(--thead);z-index:1;font-weight:700}
    th:nth-child(1),td:nth-child(1){width:28%}
    th:nth-child(2),td:nth-child(2){width:40%}
    th:nth-child(3),td:nth-child(3){width:32%}
    .ops{display:flex;align-items:center;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .link-icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;line-height:1;text-decoration:none;font-size:18px;border-radius:8px}
    .link-icon:hover{background:#f3f4f6}
    .link-icon:active{transform:translateY(1px)}

    .kind-chip{
      display:inline-flex;align-items:center;
      max-width:100%;
      padding:4px 8px;
      border-radius:999px;
      font-size:13px;
      background:var(--chip-bg);
      color:var(--chip-text);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      border:1px solid var(--line);
    }

    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{border-bottom:1px solid var(--line);padding:12px 2px;display:flex;flex-direction:column;gap:6px}
      .l1{font-size:16px;line-height:1.6;font-weight:700;display:flex;gap:6px;flex-wrap:wrap}
      .l1 .sep{opacity:.6}
      .l2{display:flex;align-items:center;gap:8px;justify-content:flex-end;flex-wrap:wrap}
      .dm-select-wrap{flex:7 1 0}
      .dm-btn-wrap{flex:3 1 0}
    }

    .page{display:none}.page.active{display:block}
    .history-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .back{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    .back:hover{background:#f9fafb}
    .title{font-weight:700}
    .history-list{margin-top:8px}
    .history-item{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding:10px 4px;gap:8px}
    .history-left{display:flex;align-items:center;gap:8px;min-width:0}
    .history-date{white-space:nowrap;color:#374151}
    .history-item a{color:var(--link);text-decoration:none}
    .history-item a:hover{text-decoration:underline}
    .skeleton{height:16px;background:#eef6ff;border-radius:6px;margin:6px 0}
  </style>
</head>
<body>
  <!-- ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
  <div id="page-list" class="page active">
    <div class="card">
      <div class="topbar">
        <div class="tabs" role="tablist" aria-label="æ¤œç´¢å¯¾è±¡">
          <button id="tab-songs" class="tab" role="tab" aria-selected="true"  data-tab="songs">æ­Œå”±æ›²</button>
          <button id="tab-gags"  class="tab" role="tab" aria-selected="false" data-tab="gags">ä¸€ç™ºãƒã‚¿</button>
        </div>
        <div class="limit-wrap">
          <label for="limit" class="muted" style="white-space:nowrap;">è¡¨ç¤º</label>
          <select id="limit" aria-label="è¡¨ç¤º">
            <option value="10" selected>10ä»¶</option>
            <option value="50">50ä»¶</option>
            <option value="all">å…¨ã¦</option>
          </select>
        </div>
      </div>

      <div class="row">
        <input id="q" type="search" placeholder="æ›²åï¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢" autocomplete="off">
      </div>

      <div class="dm-wrap" aria-label="å¼¾å¹•ã‚³ãƒ”ãƒ¼">
        <div class="dm-select-wrap">
          <select id="dm-select" title="å¼¾å¹•ã®ç¨®é¡ã‚’é¸æŠ">
            <option value="âš›ï¸ğŸŒê•¤.â€Ë–Ù­*âš›ï¸ğŸŒê•¤.â€Ë–Ù­*âš›ï¸ğŸŒê•¤.â€Ë–Ù­*âš›ï¸ğŸŒê•¤.â€Ë–Ù­*">âš›ï¸ğŸŒê•¤.â€Ë–Ù­ï¼ˆèŠ±ï¼‰</option>
            <option value="âš›ï¸ğŸŒâ™¬*.+âš›ï¸ğŸŒâ™¬*.+âš›ï¸ğŸŒâ™¬*.+âš›ï¸ğŸŒâ™¬*.+">âš›ï¸ğŸŒâ™¬*.+ï¼ˆéŸ³ç¬¦ï¼‰</option>
            <option value="âœ¨âš›ï¸ğŸŒğŸµâœ¨âš›ï¸ğŸŒğŸµâœ¨âš›ï¸ğŸŒğŸµâœ¨âš›ï¸ğŸŒğŸµ">âœ¨âš›ï¸ğŸŒğŸµï¼ˆã‚­ãƒ©éŸ³ç¬¦ï¼‰</option>
          </select>
        </div>
        <div class="dm-btn-wrap">
          <button id="dm-copy" class="btn btn-full" type="button" title="é¸æŠã—ãŸå¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼">ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>

      <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="muted" id="hint">æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      <div id="table" style="display:none;"></div>
      <div id="mblist" class="mobile-list" style="display:none;"></div>
    </div>
  </div>

  <!-- å±¥æ­´ãƒšãƒ¼ã‚¸ -->
  <div id="page-history" class="page">
    <div class="card">
      <div class="history-header">
        <button id="btn-back" class="back">â† æˆ»ã‚‹</button>
        <div class="title" id="hist-title">/</div>
      </div>
      <div class="muted" id="hist-sub">æ­Œå”±å±¥æ­´ã‚’æ–°ã—ã„é †ã«è¡¨ç¤ºã—ã¾ã™ã€‚</div>
    </div>
    <div class="card" style="margin-top:12px;">
      <div id="hist-list" class="history-list"></div>
      <div id="hist-empty" class="muted" style="display:none;">è©²å½“ã™ã‚‹å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    const DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbwybI81qIBMYN3AYNuPiD4WjPNYHYWa8wkC2tp2Vfx8hedoHKe-boZPa6KRtGZCNoJpXQ/exec';
    const API_URL = DEPLOY_URL;
    const HARD_LIMIT = 10000;
    const ARCHIVE_VERSION = 'v2.5';

    const state = {
      current: 'songs',
      cache: { songs:null, gags:null },
      debounce: null,
      archiveByKey: null,
      archiveByTitle: null,
      lastScroll: 0,
      histKey: null
    };

    const $ = id => document.getElementById(id);
    const normalize = s => (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
    const showToast = msg => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); };
    async function copyText(text){
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }catch{ showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }
    async function copyPair(title, artist){
      const text = `${(title||'').trim()} / ${(artist||'').trim()}`.trim();
      await copyText(text);
    }
    document.getElementById('dm-copy').addEventListener('click', ()=>{
      const v = $('dm-select').value || '';
      copyText(v);
    });

    const urlFromText = s => { if(!s) return ''; const m=String(s).match(/https?:\/\/\S+/); return m ? m[0].replace(/[)\]\s]+$/,'') : ''; };
    const extractDate8 = s => { const m=/^(\d{8})/.exec(String(s||'')); return m ? parseInt(m[1],10) : 0; };

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      $(id).classList.add('active');
    }

    function buildArchiveIndex(rows){
      const byKey = new Map();
      const byTitle = new Map();
      for(const r of rows){
        const a = normalize(r.artist), t = normalize(r.title);
        const url = r.dUrl || urlFromText(r.dText);
        if(!url) continue;
        const date = extractDate8(r.dText);
        const kind = (r.kind || '').toString();
        const key = `${a}|${t}`, tkey = t;
        (byKey.get(key)  || byKey.set(key,[]).get(key)).push({date,url,kind});
        (byTitle.get(tkey)|| byTitle.set(tkey,[]).get(tkey)).push({date,url,kind});
      }
      const sortDesc = arr => arr.sort((x,y)=> y.date - x.date || (x.url>y.url?1:-1));
      for(const arr of byKey.values()) sortDesc(arr);
      for(const arr of byTitle.values()) sortDesc(arr);
      state.archiveByKey = byKey;
      state.archiveByTitle = byTitle;
    }

    function tryLoadArchiveFromCache(){
      try{
        const ver = localStorage.getItem('archiveVersion');
        const json = localStorage.getItem('archiveJson');
        if(ver===ARCHIVE_VERSION && json){
          const rows = JSON.parse(json);
          buildArchiveIndex(rows);
          return true;
        }
      }catch{}
      return false;
    }
    function saveArchiveToCache(rows){
      try{
        localStorage.setItem('archiveVersion', ARCHIVE_VERSION);
        localStorage.setItem('archiveJson', JSON.stringify(rows));
        localStorage.setItem('archiveUpdatedAt', String(Date.now()));
      }catch{}
    }

    let __jsonpHit = false;
    const REQUEST_MAX_RETRY = 2;
    const REQUEST_TIMEOUT_MS = 4500;
    const REQUEST_RETRY_DELAY_MS = 500;
    const FETCH_TIMEOUT_MS = 6000;
    const JSONP_ALLOWED_ORIGIN = 'script.google.com';
    const JSONP_CALLBACK_RE = /^[A-Za-z_$][0-9A-Za-z_$]*$/;
    const requestState = {
      songs: { id:0, timer:null, inflight:false },
      gags: { id:0, timer:null, inflight:false },
      archive: { id:0, timer:null, inflight:false }
    };

    function clearRequestTimer(tab){
      const req = requestState[tab];
      if (!req) return;
      if (req.timer) clearTimeout(req.timer);
      req.timer = null;
    }
    function markRequestSuccess(tab){
      if (!requestState[tab]) return;
      const req = requestState[tab];
      req.inflight = false;
      clearRequestTimer(tab);
    }
    function showRequestError(tab, reason){
      if (tab === 'archive') {
        if (state.histKey) {
          $('hist-sub').textContent = state.archiveByKey
            ? `å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤ºä¸­ï¼‰: ${reason}`
            : `å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${reason}`;
          if (!state.archiveByKey) {
            $('hist-list').innerHTML = '';
            $('hist-empty').style.display = 'block';
          }
        }
        return;
      }

      if (state.current === tab || !state.cache[state.current]) {
        $('status').textContent = `ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ${tab}ï¼‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${reason}`;
      }
    }

    function handleRequestFailure(tab, attempt, reason){
      const req = requestState[tab];
      if (!req) return;
      req.inflight = false;
      clearRequestTimer(tab);

      if (attempt < REQUEST_MAX_RETRY) {
        const next = attempt + 1;
        console.warn(`[${tab}] request failed: ${reason}. retry=${next}/${REQUEST_MAX_RETRY}`);
        setTimeout(()=>requestData(tab, next), REQUEST_RETRY_DELAY_MS * next);
        return;
      }

      showRequestError(tab, reason);
    }

    function normalizeRows(payloadRows){
      return (payloadRows||[])
        .map(r => ({
          artist: r.artist ?? r.Artist ?? r.ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ ?? '',
          title : r.title  ?? r.Title  ?? r.æ›²å       ?? '',
          kind  : r.kind   ?? r.Kind   ?? r.åŒºåˆ†       ?? '',
          dText : r.dText  ?? r.dtext  ?? r.DTEXT      ?? r.text ?? '',
          dUrl  : r.dUrl   ?? r.durl   ?? r.DURL       ?? r.url  ?? ''
        }))
        .filter(r => ((r.artist||'')+(r.title||'')).trim()!=='');
    }

    function handlePayload(tab, payload){
      __jsonpHit = true;
      try{
        if (!payload || !Array.isArray(payload.rows)) {
          if (state.histKey) {
            $('hist-list').innerHTML = '';
            $('hist-empty').style.display = 'block';
            $('hist-sub').textContent = 'å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
          } else {
            $('status').textContent = 'ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚';
          }
          return;
        }

        const rawSheet = String(payload.sheet || payload.sheetName || payload.name || '').toLowerCase();
        if (rawSheet && rawSheet !== tab) {
          throw new Error(`å–å¾—å…ƒä¸ä¸€è‡´: request=${tab}, response=${rawSheet}`);
        }

        if (tab === 'archive') {
          markRequestSuccess('archive');
          const rows = normalizeRows(payload.rows);
          buildArchiveIndex(rows);
          saveArchiveToCache(rows);
          if (state.histKey) renderHistory(state.histKey.artist, state.histKey.title);
          return;
        }

        if (tab === 'songs' || tab === 'gags') {
          markRequestSuccess(tab);
          const rows = normalizeRows(payload.rows)
            .map(r => ({
              ...r,
              _na: normalize(r.artist),
              _nt: normalize(r.title)
            }));
          state.cache[tab] = rows;

          if (state.cache[state.current]) {
            $('status').textContent = `èª­ã¿è¾¼ã¿å®Œäº†ï¼š${state.cache[state.current].length}ä»¶`;
            render();
          } else {
            $('status').textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';
          }
          return;
        }

        if (state.histKey) {
          $('hist-list').innerHTML = '';
          $('hist-empty').style.display = 'block';
          $('hist-sub').textContent = 'ä¸æ˜ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚';
        } else {
          $('status').textContent = 'ä¸æ˜ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚';
        }
      }catch(e){
        console.error(e);
        if (state.histKey) {
          $('hist-list').innerHTML = '';
          $('hist-empty').style.display = 'block';
          $('hist-sub').textContent = 'å±¥æ­´ã®æç”»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        } else {
          $('status').textContent='èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        }
      }
    }

    setTimeout(()=>{
      if(!__jsonpHit && $('page-list').classList.contains('active')){
        $('status').textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSONPæœªç€ï¼API_URLã¨ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªï¼‰';
      }
    }, 4000);

    function toSafeApiBase(rawUrl){
      const src = String(rawUrl || '').replace(/\/macros\/u\/\d+\//,'/macros/');
      const u = new URL(src);
      if (u.protocol !== 'https:') throw new Error('API URLã¯httpsã®ã¿è¨±å¯ã—ã¦ã„ã¾ã™');
      if (u.hostname !== JSONP_ALLOWED_ORIGIN) throw new Error('è¨±å¯ã•ã‚Œã¦ã„ãªã„JSONPãƒ›ã‚¹ãƒˆã§ã™');
      if (!/^\/macros\/s\/[A-Za-z0-9_-]+\/exec$/.test(u.pathname)) throw new Error('API URLå½¢å¼ãŒä¸æ­£ã§ã™');
      return u;
    }

    function buildApiRequestUrl(tab, callbackName, useDeploy){
      const base = toSafeApiBase(useDeploy ? DEPLOY_URL : API_URL);
      base.search = new URLSearchParams({
        callback: callbackName,
        sheet: tab,
        authuser: '0',
        v: String(Date.now())
      }).toString();
      return base.toString();
    }
    function buildApiFetchUrl(tab, useDeploy){
      const base = toSafeApiBase(useDeploy ? DEPLOY_URL : API_URL);
      base.search = new URLSearchParams({
        sheet: tab,
        authuser: '0',
        v: String(Date.now())
      }).toString();
      return base.toString();
    }

    function jsonp(tab, attempt, useDeploy = false){
      const req = requestState[tab];
      if (!req) return;

      clearRequestTimer(tab);
      req.id += 1;
      req.inflight = true;
      const requestId = req.id;
      const callbackName = `__jsonp_${tab}_${Date.now()}_${Math.random().toString(36).slice(2)}`;
      if (!JSONP_CALLBACK_RE.test(callbackName)) {
        handleRequestFailure(tab, attempt, 'callbackåã®ç”Ÿæˆã«å¤±æ•—');
        return;
      }

      let script = null;
      const cleanup = () => {
        clearRequestTimer(tab);
        if (script && script.parentNode) script.parentNode.removeChild(script);
        script = null;
        delete window[callbackName];
      };

      window[callbackName] = (payload) => {
        if (req.id !== requestId) return;
        req.inflight = false;
        cleanup();
        try {
          handlePayload(tab, payload);
        } catch (err) {
          const reason = err instanceof Error ? err.message : String(err);
          if (!useDeploy && reason.startsWith('å–å¾—å…ƒä¸ä¸€è‡´')) {
            console.warn(`[${tab}] ${reason}. deploy URLã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚`);
            requestData(tab, attempt, true);
            return;
          }
          handleRequestFailure(tab, attempt, reason);
        }
      };

      script=document.createElement('script');
      script.src = buildApiRequestUrl(tab, callbackName, useDeploy);
      script.referrerPolicy = 'no-referrer';
      script.onerror=()=>{
        if (req.id !== requestId) return;
        req.inflight = false;
        cleanup();
        requestData(tab, attempt, useDeploy, 'fetch');
      };
      document.head.appendChild(script);

      req.timer = setTimeout(()=>{
        if (req.id !== requestId || !req.inflight) return;
        req.inflight = false;
        cleanup();
        requestData(tab, attempt, useDeploy, 'fetch');
      }, REQUEST_TIMEOUT_MS);
    }
    async function requestByFetch(tab, attempt, useDeploy = false){
      const req = requestState[tab];
      if (!req) return;

      clearRequestTimer(tab);
      req.id += 1;
      req.inflight = true;
      const requestId = req.id;

      const controller = new AbortController();
      req.timer = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

      try {
        const res = await fetch(buildApiFetchUrl(tab, useDeploy), {
          signal: controller.signal,
          mode: 'cors',
          credentials: 'omit',
          cache: 'no-store'
        });
        if (req.id !== requestId) return;
        req.inflight = false;
        clearRequestTimer(tab);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const payload = await res.json();
        handlePayload(tab, payload);
      } catch (err) {
        if (req.id !== requestId) return;
        req.inflight = false;
        clearRequestTimer(tab);

        const reason = err && err.name === 'AbortError'
          ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ'
          : 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ãƒ–ãƒ­ãƒƒã‚¯';
        handleRequestFailure(tab, attempt, reason);
      }
    }
    function requestData(tab, attempt = 0, useDeploy = false, transport = 'jsonp'){
      if (transport === 'fetch') {
        requestByFetch(tab, attempt, useDeploy);
        return;
      }
      jsonp(tab, attempt, useDeploy);
    }
    function ensureArchiveFast(){
      const hasCache = tryLoadArchiveFromCache();
      if (!requestState.archive.inflight) requestData('archive');
      if (state.histKey && hasCache) renderHistory(state.histKey.artist, state.histKey.title);
    }

    function setActiveTab(tab){
      state.current = tab;
      document.querySelectorAll('.tab').forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab===tab)));
      $('status').textContent='èª­ã¿è¾¼ã¿ä¸­â€¦';
      if (!state.cache[tab] && !requestState[tab].inflight) requestData(tab);
      if (state.cache[tab]) {
        $('status').textContent = `è¡¨ç¤ºä¸­ï¼š${state.cache[tab].length}ä»¶`;
        render();
      }
    }

    function renderHistory(artist, title){
      state.histKey = { artist, title };
      $('hist-title').textContent = `${artist || ''} / ${title || ''}`;

      const wrap = $('hist-list');
      const empty = $('hist-empty');
      wrap.innerHTML = '';
      empty.style.display = 'none';

      if (!state.archiveByKey || !state.archiveByTitle) {
        ensureArchiveFast();
        for(let i=0;i<6;i++){ const sk=document.createElement('div'); sk.className='skeleton'; wrap.appendChild(sk); }
        $('hist-sub').textContent = 'å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
        return;
      }

      const key = `${normalize(artist)}|${normalize(title)}`;
      let list = state.archiveByKey.get(key);
      if (!list || list.length===0) list = state.archiveByTitle.get(normalize(title)) || [];

      const songs = state.cache.songs || [];
      let latestFromSongs = null;
      for (const row of songs) {
        if (row._na !== normalize(artist) || row._nt !== normalize(title)) continue;
        const url = row.dUrl || urlFromText(row.dText);
        const date = extractDate8(row.dText);
        const candidate = { date, url, kind: row.kind || '' };
        if (!latestFromSongs || candidate.date > latestFromSongs.date) latestFromSongs = candidate;
      }

      const mergedList = [...list];
      if (latestFromSongs && latestFromSongs.url) {
        const exists = mergedList.some(item =>
          item.date === latestFromSongs.date &&
          item.url === latestFromSongs.url &&
          (item.kind || '') === (latestFromSongs.kind || '')
        );
        if (!exists) mergedList.unshift(latestFromSongs);
      }

      if (mergedList.length===0){
        empty.style.display = 'block';
        return;
      }

      $('hist-sub').textContent = 'æ–°ã—ã„é †ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚';

      const CHUNK = 50;
      let i = 0;
      function drawChunk(){
        const frag = document.createDocumentFragment();
        const end = Math.min(i+CHUNK, mergedList.length);
        for(; i<end; i++){
          const {date,url,kind} = mergedList[i];
          const yyyy = Math.floor(date/10000), mm=Math.floor((date%10000)/100), dd=date%100;
          const dateLabel = date ? `${yyyy}/${String(mm).padStart(2,'0')}/${String(dd).padStart(2,'0')}` : '----/--/--';

          const row = document.createElement('div'); row.className='history-item';

          const left = document.createElement('div'); left.className='history-left';
          // å…ˆã«æ—¥ä»˜
          const dt = document.createElement('span');
          dt.className = 'history-date';
          dt.textContent = dateLabel;
          left.appendChild(dt);
          // æ¬¡ã« Cåˆ—ï¼ˆåŒºåˆ†ï¼‰â€»ç©ºãªã‚‰å‡ºã•ãªã„
          if ((kind || '').trim() !== '') {
            const k = document.createElement('span');
            k.className = 'kind-chip';
            k.textContent = kind;
            left.appendChild(k);
          }

          const right = document.createElement('div');
          if (url) { const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.textContent='â–¶ é–‹ã'; right.appendChild(a); }
          else { const span=document.createElement('span'); span.className='muted'; span.textContent='ãƒªãƒ³ã‚¯ãªã—'; right.appendChild(span); }

          row.appendChild(left); row.appendChild(right);
          frag.appendChild(row);
        }
        wrap.appendChild(frag);
        if (i < mergedList.length) requestAnimationFrame(drawChunk);
      }
      requestAnimationFrame(drawChunk);
    }


    function openHistory(artist, title){
      state.lastScroll = window.scrollY || document.documentElement.scrollTop || 0;
      showPage('page-history');
      if (!state.archiveByKey) ensureArchiveFast();
      renderHistory(artist, title);
    }

    function appendItemActions(target, {artist, title, kind, dText, dUrl}){
      if ((kind||'').trim()!==''){
        const k=document.createElement('span'); k.className='kind-chip'; k.textContent=kind;
        target.appendChild(k);
      }

      const url = dUrl || urlFromText(dText);
      if (url){
        const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.className='link-icon'; a.textContent='â–¶'; a.title='ãƒªãƒ³ã‚¯ã‚’é–‹ã';
        target.appendChild(a);
      }

      const hbtn=document.createElement('button'); hbtn.className='btn'; hbtn.textContent='å±¥æ­´';
      hbtn.addEventListener('click', ()=>openHistory(artist, title));
      target.appendChild(hbtn);

      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='ã‚³ãƒ”ãƒ¼';
      btn.addEventListener('click', ()=>copyPair(title,artist));
      target.appendChild(btn);
    }
    function render(){
      const tableWrap = $('table'); tableWrap.innerHTML = '';
      const listWrap  = $('mblist'); listWrap.innerHTML = '';
      const hint = $('hint');

      if (!state.cache[state.current]) {
        $('status').textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';
        tableWrap.style.display = 'none';
        listWrap.style.display  = 'none';
        return;
      }

      const q = normalize($('q').value||'');
      const rawLimit = $('limit').value;
      const limitParsed = (rawLimit === 'all') ? Number.POSITIVE_INFINITY : parseInt(rawLimit,10) || 10;
      const effectiveLimit = Math.min(limitParsed, HARD_LIMIT);

      let filtered = state.cache[state.current] || [];
      if(q){ filtered = filtered.filter(r => r._na.includes(q) || r._nt.includes(q)); }
      const rows = filtered.slice(0, effectiveLimit);

      const limitLabel = (rawLimit === 'all') ? 'å…¨ã¦' : `${effectiveLimit}ä»¶`;
      $('status').textContent = q
        ? `${rows.length}ä»¶ãƒ’ãƒƒãƒˆï¼ˆå…¨${filtered.length}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`
        : `è¡¨ç¤ºä¸­ ${rows.length}ä»¶ï¼ˆå…¨${(state.cache[state.current]||[]).length}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`;

      if(rows.length===0){
        hint.textContent = q ? 'è©²å½“ãªã—' : 'æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        tableWrap.style.display = 'none';
        listWrap.style.display  = 'none';
        return;
      }
      hint.textContent = '';

      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      if (!isMobile) {
        const table=document.createElement('table');
        const thead=document.createElement('thead');
        const trh=document.createElement('tr');
        ['ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå','æ›²å','æ“ä½œ'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
        thead.appendChild(trh); table.appendChild(thead);

        const tbody=document.createElement('tbody');
        rows.forEach(({artist,title,kind,dText,dUrl})=>{
          const tr=document.createElement('tr');

          let td=document.createElement('td'); td.textContent=artist||''; tr.appendChild(td);
          td=document.createElement('td'); td.textContent=title||''; tr.appendChild(td);

          const tdOps=document.createElement('td');
          const ops=document.createElement('div'); ops.className='ops';

          appendItemActions(ops, {artist, title, kind, dText, dUrl});

          tdOps.appendChild(ops); tr.appendChild(tdOps); tbody.appendChild(tr);
        });
        table.appendChild(tbody); tableWrap.appendChild(table);
        tableWrap.style.display = 'block'; listWrap.style.display = 'none';
      } else {
        rows.forEach(({artist,title,kind,dText,dUrl})=>{
          const item=document.createElement('div'); item.className='item';
          const l1=document.createElement('div'); l1.className='l1';
          const a1=document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
          const sep=document.createElement('span'); sep.className='sep'; sep.textContent='/';
          const t1=document.createElement('span'); t1.className='title'; t1.textContent=title||'';
          l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

          const l2=document.createElement('div'); l2.className='l2';

          appendItemActions(l2, {artist, title, kind, dText, dUrl});

          item.appendChild(l1); item.appendChild(l2); $('mblist').appendChild(item);
        });
        $('mblist').style.display = 'block'; $('table').style.display = 'none';
      }
    }

    $('btn-back').addEventListener('click', ()=>{
      showPage('page-list'); window.scrollTo({ top: state.lastScroll || 0 });
    });

    window.addEventListener('resize', ()=>{ clearTimeout(state.debounce); state.debounce=setTimeout(render,150); });

    (function init(){
      document.getElementById('tab-songs').addEventListener('click', ()=> setActiveTab('songs'));
      document.getElementById('tab-gags').addEventListener('click',  ()=> setActiveTab('gags'));
      $('q').addEventListener('input', ()=>{ clearTimeout(state.debounce); state.debounce=setTimeout(render,200); });
      $('limit').addEventListener('change', render);

      showPage('page-list');
      setActiveTab('songs');
      if (!state.cache['gags'])  requestData('gags');

      ensureArchiveFast();
    })();
  </script>
</body>
</html>
